# Raspberry Pi 4 configuration for the Eclipse SDV hackathon.
# 
# Combines the standard RPi4 BSP with a configuration offering variables used by the 
# EWAOL distribution. Namely, defines a single pre-built DomU, with Ubuntu 20.04.5 LTS.

header:
  version: 11
  includes:
    - repo: meta-ewaol
      file: meta-ewaol-config/kas/virtualization.yml

machine: raspberrypi4-64

repos:
  meta-ewaol-hackathon:
    layers:
      meta-ewaol-hackathon:

  meta-raspberrypi:
    url: https://github.com/agherzan/meta-raspberrypi.git
    refspec: kirkstone
    path: layers/meta-raspberrypi

  meta-ewaol:
    url: https://git.gitlab.arm.com/ewaol/meta-ewaol.git
    refspec: kirkstone-dev
    path: layers/meta-ewaol
    layers:
      meta-ewaol-distro:
      meta-ewaol-tests:

local_conf_header:
  meta-hackathon: |
    ENABLE_UART = "1"
    RPI_EXTRA_CONFIG += "\ndtoverlay=disable-bt"

    CMDLINE_DEBUG += " cgroup_memory=1 cgroup_enable=memory"

    # Prebuilt VM instance 1 (Ubuntu 20.04.5 for Muto and other network services)
    # Handled by ubuntu-xenguest recipe
    
    # Because we can't mandate layer order when using kas, letting
    # meta-ewaol insert the xen and virtualization DISTRO_FEATURES
    # is insufficent to guarantee these flags are observed by meta-raspberrypi (or others).
    # Repeat them here as local.conf is parsed before layer.confs.
    DISTRO_FEATURES:append = " virtualization xen"
    
    # EWAOL requires greater memory in the control domain.
    # (configuring this considering use of a 4GB Raspberry Pi 4)
    # ! CHANGEME !
    EWAOL_CONTROL_VM_MEMORY_SIZE := "1024"

    # Disable default EWAOL guest VM.
    # (configuring this considering use of a 4GB Raspberry Pi 4)
    # ! CHANGEME !
    EWAOL_GUEST_VM_INSTANCES := "0"

